---
- name: HomeLab System Health Check
  hosts: raspberry_pi
  gather_facts: true
  become: false
  vars_files:
    - vars/main.yml

  tasks:
    # === SYSTEM OVERVIEW ===
    - name: Get system info
      setup:
      register: system_facts

    - name: Get system uptime
      shell: uptime -p
      register: system_uptime
      ignore_errors: true

    - name: Get memory usage
      shell: free -h | grep Mem | awk '{print $3"/"$2}'
      register: memory_usage
      ignore_errors: true

    - name: Get disk usage
      shell: df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}'
      register: disk_usage
      ignore_errors: true

    # === SERVICE CHECKS ===
    
    # MariaDB Health Check
    - name: Check MariaDB service status
      systemd:
        name: mariadb
      register: mariadb_service
      become: true
      ignore_errors: true

    - name: Test MariaDB connection
      shell: mysql -u root -e "SELECT 1;" 2>/dev/null
      register: mariadb_connection
      ignore_errors: true

    - name: Get MariaDB version
      shell: mysql -V 2>/dev/null | grep -oP 'mariadb.*?[0-9]+\.[0-9]+\.[0-9]+' || echo "Not available"
      register: mariadb_version
      ignore_errors: true

    # Mosquitto Health Check
    - name: Check Mosquitto service status
      systemd:
        name: mosquitto
      register: mosquitto_service
      become: true
      ignore_errors: true

    - name: Test Mosquitto port
      wait_for:
        port: 1883
        host: localhost
        timeout: 3
      register: mosquitto_port
      ignore_errors: true

    - name: Get Mosquitto version
      shell: mosquitto -h 2>&1 | head -1 | grep -oP 'version [0-9]+\.[0-9]+\.[0-9]+' || echo "version unknown"
      register: mosquitto_version
      ignore_errors: true

    # Redis Health Check
    - name: Check Redis service status
      systemd:
        name: redis-server
      register: redis_service
      become: true
      ignore_errors: true

    - name: Test Redis connection
      shell: 'redis-cli -a "{{ vault_redis_password }}" ping 2>/dev/null'
      register: redis_connection
      ignore_errors: true

    - name: Get Redis info
      shell: 'redis-cli info server 2>/dev/null | grep redis_version | cut -d: -f2 | tr -d "\r" || echo "unknown"'
      register: redis_version
      ignore_errors: true

    # UV Health Check
    - name: Check if UV is installed
      shell: which uv
      register: uv_installed
      ignore_errors: true

    - name: Get UV version
      shell: uv --version 2>/dev/null || echo "uv unknown"
      register: uv_version
      ignore_errors: true

    - name: Test UV functionality
      shell: uv pip --help >/dev/null 2>&1
      register: uv_functional
      ignore_errors: true

    # Git Health Check
    - name: Check if Git is installed
      shell: which git
      register: git_installed
      ignore_errors: true

    - name: Get Git version
      shell: git --version 2>/dev/null || echo "git unknown"
      register: git_version
      ignore_errors: true

    - name: Test Git functionality
      shell: git --help >/dev/null 2>&1
      register: git_functional
      ignore_errors: true

    - name: Get Git user configuration
      shell: |
        echo "User: $(git config --global user.name 2>/dev/null || echo 'not configured')"
        echo "Email: $(git config --global user.email 2>/dev/null || echo 'not configured')"
      register: git_config
      ignore_errors: true

    # Grafana Health Check
    - name: Check Grafana service status
      systemd:
        name: grafana-server
      register: grafana_service
      become: true
      ignore_errors: true

    - name: Test Grafana web interface
      uri:
        url: http://localhost:3000/api/health
        method: GET
        timeout: 15
      register: grafana_web
      ignore_errors: true

    # Grafana version endpoint requires authentication, skipping

    # Loki Health Check
    - name: Check Loki service status
      systemd:
        name: loki
      register: loki_service
      become: true
      ignore_errors: true

    - name: Test Loki API
      uri:
        url: http://localhost:3100/ready
        method: GET
        timeout: 5
      register: loki_api
      ignore_errors: true

    - name: Check Promtail service status
      systemd:
        name: promtail
      register: promtail_service
      become: true
      ignore_errors: true

    - name: Test Promtail metrics
      uri:
        url: http://localhost:9080/metrics
        method: GET
        timeout: 5
      register: promtail_metrics
      ignore_errors: true

    # Deployed Applications Health Check
    - name: Load apps configuration if exists
      include_vars:
        file: config/apps.yml
        name: apps_config
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: Get list of configured app names
      set_fact:
        configured_apps: "{{ apps_config.keys() | list if apps_config is defined else [] }}"

    - name: Check status of deployed applications
      systemd:
        name: "{{ item }}"
      register: app_services_status
      become: true
      loop: "{{ configured_apps }}"
      ignore_errors: true
      when: configured_apps | length > 0

    - name: Get port information from service files
      shell: |
        if [ -f "/etc/systemd/system/{{ item }}.service" ]; then
          grep -oP '(?<=--port )[0-9]+' "/etc/systemd/system/{{ item }}.service" || echo "N/A"
        else
          echo "N/A"
        fi
      register: app_ports
      become: true
      loop: "{{ configured_apps }}"
      ignore_errors: true
      when: configured_apps | length > 0
      changed_when: false

    # === HEALTH REPORT ===
    - name: Create reports directory
      file:
        path: "{{ playbook_dir }}/../reports"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Generate timestamp for report filename
      set_fact:
        report_timestamp: "{{ ansible_date_time.year }}{{ ansible_date_time.month }}{{ ansible_date_time.day }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}"

    - name: Generate Health Check Report Content
      set_fact:
        health_report: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              HOMELAB HEALTH CHECK REPORT                         â•‘
          â•‘                       {{ ansible_date_time.date }} {{ ansible_date_time.time }}                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š SYSTEM OVERVIEW:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ–¥ï¸  Host: {{ ansible_hostname }} ({{ ansible_default_ipv4.address }})
          â±ï¸  Uptime: {{ system_uptime.stdout | default('Unknown') }}
          ğŸ§  Memory: {{ memory_usage.stdout | default('Unknown') }}
          ğŸ’¾ Disk: {{ disk_usage.stdout | default('Unknown') }}
          ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ”¥ CPU: {{ ansible_processor[2] | default('Unknown') }}
          
          âœ… SERVICE STATUS CHECKLIST:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          {% set mariadb_ok = mariadb_service.status.ActiveState|default('unknown') == 'active' and mariadb_connection.rc|default(1) == 0 %}
          {% set mosquitto_ok = mosquitto_service.status.ActiveState|default('unknown') == 'active' and mosquitto_port.failed|default(true) == false %}
          {% set redis_ok = redis_service.status.ActiveState|default('unknown') == 'active' and redis_connection.stdout|default('') == 'PONG' %}
          {% set uv_ok = uv_installed.rc|default(1) == 0 and uv_functional.rc|default(1) == 0 %}
          {% set git_ok = git_installed.rc|default(1) == 0 and git_functional.rc|default(1) == 0 %}
          {% set grafana_ok = grafana_service.status.ActiveState|default('unknown') == 'active' and grafana_web.status|default(0) == 200 %}
          {% set loki_ok = loki_service.status.ActiveState|default('unknown') == 'active' and loki_api.status|default(0) == 200 %}
          {% set promtail_ok = promtail_service.status.ActiveState|default('unknown') == 'active' and promtail_metrics.status|default(0) == 200 %}
          
          {{ 'âœ…' if mariadb_ok else 'âŒ' }} MariaDB Database
             â””â”€ Service: {{ mariadb_service.status.ActiveState|default('unknown') }}
             â””â”€ Connection: {{ 'OK' if mariadb_connection.rc|default(1) == 0 else 'FAILED' }}
             â””â”€ Version: {{ mariadb_version.stdout|default('Unknown') }}
             â””â”€ Port: 3306
          
          {{ 'âœ…' if mosquitto_ok else 'âŒ' }} Mosquitto MQTT Broker  
             â””â”€ Service: {{ mosquitto_service.status.ActiveState|default('unknown') }}
             â””â”€ Port 1883: {{ 'OPEN' if mosquitto_port.failed|default(true) == false else 'CLOSED' }}
             â””â”€ Version: {{ mosquitto_version.stdout|default('Unknown') }}
          
          {{ 'âœ…' if redis_ok else 'âŒ' }} Redis Cache Server
             â””â”€ Service: {{ redis_service.status.ActiveState|default('unknown') }}
             â””â”€ Connection: {{ 'PONG' if redis_connection.stdout|default('') == 'PONG' else 'FAILED' }}
             â””â”€ Version: {{ redis_version.stdout|default('Unknown') }}
             â””â”€ Port: 6379
          
          {{ 'âœ…' if uv_ok else 'âŒ' }} UV Python Package Manager
             â””â”€ Installation: {{ 'OK' if uv_installed.rc|default(1) == 0 else 'NOT FOUND' }}
             â””â”€ Functionality: {{ 'OK' if uv_functional.rc|default(1) == 0 else 'ERROR' }}
             â””â”€ Version: {{ uv_version.stdout|default('Unknown') }}
          
          {{ 'âœ…' if git_ok else 'âŒ' }} Git Version Control System
             â””â”€ Installation: {{ 'OK' if git_installed.rc|default(1) == 0 else 'NOT FOUND' }}
             â””â”€ Functionality: {{ 'OK' if git_functional.rc|default(1) == 0 else 'ERROR' }}
             â””â”€ Version: {{ git_version.stdout|default('Unknown') }}
             â””â”€ Configuration: {{ git_config.stdout_lines[0]|default('User: not configured') }}
          
          {{ 'âœ…' if grafana_ok else 'âŒ' }} Grafana Monitoring Dashboard
             â””â”€ Service: {{ grafana_service.status.ActiveState | default('unknown') }}
             â””â”€ Web UI: {{ 'OK' if grafana_web.status | default(0) == 200 else 'FAILED' }}
             â””â”€ Version: Available via web UI
             â””â”€ URL: http://{{ ansible_default_ipv4.address }}:3000
          
          {{ 'âœ…' if loki_ok else 'âŒ' }} Loki Log Aggregation
             â””â”€ Service: {{ loki_service.status.ActiveState|default('unknown') }}
             â””â”€ API: {{ 'OK' if loki_api.status|default(0) == 200 else 'FAILED' }}
             â””â”€ URL: http://{{ ansible_default_ipv4.address }}:3100
          
          {{ 'âœ…' if promtail_ok else 'âŒ' }} Promtail Log Shipper
             â””â”€ Service: {{ promtail_service.status.ActiveState|default('unknown') }}
             â””â”€ Metrics: {{ 'OK' if promtail_metrics.status|default(0) == 200 else 'FAILED' }}
             â””â”€ Port: 9080
          
          ğŸ“¦ DEPLOYED APPLICATIONS:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          {% if configured_apps is defined and configured_apps | length > 0 %}
          {% for item in app_services_status.results %}
          {% set app_ok = item.status.ActiveState|default('unknown') == 'active' %}
          {% set port_info = app_ports.results[loop.index0].stdout|default('N/A') %}
          {{ 'âœ…' if app_ok else 'âŒ' }} {{ item.item }}
             â””â”€ Service: {{ item.status.ActiveState|default('unknown') }}
             â””â”€ Status: {{ item.status.SubState|default('unknown') }}
             â””â”€ PID: {{ item.status.MainPID|default('N/A') }}
             â””â”€ Port: {{ port_info }}
          {% endfor %}
          {% else %}
          â„¹ï¸  No deployed applications found
          ğŸ’¡ Deploy apps with: make deploy APP=<app-name>
          {% endif %}
          
          ğŸ“Š SUMMARY:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ—„ï¸  Database Services:    {{ 'âœ…' if mariadb_ok else 'âŒ' }} MariaDB
          ğŸ“¡  Messaging Services:   {{ 'âœ…' if mosquitto_ok else 'âŒ' }} Mosquitto
          ğŸ—‚ï¸  Cache Services:       {{ 'âœ…' if redis_ok else 'âŒ' }} Redis
          ğŸ  Development Tools:    {{ 'âœ…' if uv_ok else 'âŒ' }} UV  {{ 'âœ…' if git_ok else 'âŒ' }} Git
          ğŸ“Š  Monitoring Stack:     {{ 'âœ…' if grafana_ok else 'âŒ' }} Grafana  {{ 'âœ…' if loki_ok and promtail_ok else 'âŒ' }} Loki/Promtail
          
          {% set total_services = 8 %}
          {% set healthy_services = [mariadb_ok, mosquitto_ok, redis_ok, uv_ok, git_ok, grafana_ok, loki_ok, promtail_ok] | select('equalto', true) | list | length %}
          ğŸ¯ Overall Health: {{ healthy_services }}/{{ total_services }} services healthy ({{ ((healthy_services/total_services)*100)|round(1) }}%)
          
          {% if healthy_services == total_services %}
          ğŸ‰ ALL SYSTEMS OPERATIONAL! Your HomeLab is running perfectly! ğŸš€
          {% elif healthy_services >= 5 %}
          âš ï¸  Most systems operational. Check failed services above.
          {% else %}
          ğŸš¨ MULTIPLE SERVICES DOWN! Immediate attention required!
          {% endif %}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ’¡ Run individual service playbooks to fix issues:
             make run-playbook PLAYBOOK=<service-name>
          ğŸ”§ For complete reinstall: make setup-all CLEANUP=true

    - name: Save Health Check Report to File
      copy:
        content: "{{ health_report }}"
        dest: "{{ playbook_dir }}/../reports/health-check_{{ report_timestamp }}.txt"
        mode: '0644'
      delegate_to: localhost
      run_once: true

    - name: Display Health Check Summary
      debug:
        msg: |
          ğŸ¥ HEALTH CHECK COMPLETED
          
          ğŸ“Š Quick Summary:
          {% set total_services = 8 %}
          {% set mariadb_ok = mariadb_service.status.ActiveState|default('unknown') == 'active' and mariadb_connection.rc|default(1) == 0 %}
          {% set mosquitto_ok = mosquitto_service.status.ActiveState|default('unknown') == 'active' and mosquitto_port.failed|default(true) == false %}
          {% set redis_ok = redis_service.status.ActiveState|default('unknown') == 'active' and redis_connection.stdout|default('') == 'PONG' %}
          {% set uv_ok = uv_installed.rc|default(1) == 0 and uv_functional.rc|default(1) == 0 %}
          {% set git_ok = git_installed.rc|default(1) == 0 and git_functional.rc|default(1) == 0 %}
          {% set grafana_ok = grafana_service.status.ActiveState|default('unknown') == 'active' and grafana_web.status|default(0) == 200 %}
          {% set loki_ok = loki_service.status.ActiveState|default('unknown') == 'active' and loki_api.status|default(0) == 200 %}
          {% set promtail_ok = promtail_service.status.ActiveState|default('unknown') == 'active' and promtail_metrics.status|default(0) == 200 %}
          {% set healthy_services = [mariadb_ok, mosquitto_ok, redis_ok, uv_ok, git_ok, grafana_ok, loki_ok, promtail_ok] | select('equalto', true) | list | length %}
          
          ğŸ¯ Overall Health: {{ healthy_services }}/{{ total_services }} services ({{ ((healthy_services/total_services)*100)|round(1) }}%)
          
          ğŸ“‹ Services Status:
          {{ 'âœ…' if mariadb_ok else 'âŒ' }} MariaDB  {{ 'âœ…' if mosquitto_ok else 'âŒ' }} Mosquitto  {{ 'âœ…' if redis_ok else 'âŒ' }} Redis  {{ 'âœ…' if uv_ok else 'âŒ' }} UV  {{ 'âœ…' if git_ok else 'âŒ' }} Git
          {{ 'âœ…' if grafana_ok else 'âŒ' }} Grafana  {{ 'âœ…' if loki_ok else 'âŒ' }} Loki  {{ 'âœ…' if promtail_ok else 'âŒ' }} Promtail
          
          ğŸ“„ Detailed report saved: reports/health-check_{{ report_timestamp }}.txt
          
          {% if healthy_services == total_services %}
          ğŸ‰ ALL SYSTEMS OPERATIONAL!
          {% elif healthy_services >= 5 %}
          âš ï¸  Most systems operational. Check report for details.
          {% else %}
          ğŸš¨ MULTIPLE SERVICES DOWN! Check report immediately!
          {% endif %}